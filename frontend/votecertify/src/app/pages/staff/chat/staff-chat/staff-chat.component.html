<div class="chat-page">
  <section class="requests-panel">
    <div class="panel-header">
      <div>
        <h2>Requests</h2>
        <p>Open a request to chat with the voter.</p>
      </div>
      <button class="archived-toggle" (click)="toggleArchived()" title="Toggle archived chats">
        <span class="material-icons">{{ showArchived ? 'folder_open' : 'folder' }}</span>
      </button>
    </div>

    <div class="search-box">
      <input
        type="text"
        placeholder="Search by name or voter ID"
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilter()"
      />
    </div>

    <div class="requests-list" *ngIf="!isLoadingRequests; else loadingRequests">
      <div class="list-section" *ngIf="!showArchived">
        <div class="section-header">
          <h3>Active Chats</h3>
          <span class="count-pill">{{ filteredActiveRequests.length }}</span>
        </div>

        <ng-container *ngIf="filteredActiveRequests.length > 0; else noActive">
        <div
          class="request-card"
          *ngFor="let request of filteredActiveRequests"
          [class.selected]="request.id === selectedRequest?.id"
          [class.unread]="isUnread(request.id)"
          (click)="selectRequest(request)"
        >
            <div class="card-body">
              <div>
              <p class="request-name">
                {{ request.fullName || 'Voter' }}
                <span class="unread-dot" *ngIf="isUnread(request.id)"></span>
              </p>
              </div>
              <span class="status" [class]="(request.status || '').toLowerCase()">
                {{ request.status || 'Pending' }}
              </span>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="list-section archived" *ngIf="showArchived">
        <div class="section-header">
          <h3>Archived Chats</h3>
          <span class="count-pill">{{ filteredArchivedRequests.length }}</span>
        </div>

        <ng-container *ngIf="filteredArchivedRequests.length > 0; else noArchived">
          <div
            class="request-card"
            *ngFor="let request of filteredArchivedRequests"
            [class.selected]="request.id === selectedRequest?.id"
            (click)="selectRequest(request)"
          >
            <div class="card-body">
              <div>
                <p class="request-name">{{ request.fullName || 'Voter' }}</p>
              </div>
              <span class="status archived-status">
                {{ request.status || 'Approved' }}
              </span>
            </div>
          </div>
        </ng-container>
      </div>

      <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
    </div>

    <ng-template #noActive>
      <p class="empty">No active chats for pending requests.</p>
    </ng-template>

    <ng-template #noArchived>
      <p class="empty">No archived chats yet.</p>
    </ng-template>
  </section>

  <section class="chat-panel" *ngIf="selectedRequest; else noSelection">
    <header class="chat-header">
      <div>
        <h2>{{ selectedRequest!.fullName || 'Voter' }}</h2>
      </div>
    </header>

    <div class="request-info">
      <div class="info-item">
        <span class="label">Purpose:</span>
        <span class="value">{{ selectedRequest!.purpose || 'N/A' }}</span>
      </div>
      <div class="info-item">
        <span class="label">Status:</span>
        <span class="value" [class]="(selectedRequest!.status || '').toLowerCase()">{{ selectedRequest!.status || 'Pending' }}</span>
      </div>
    </div>

    <div class="messages" #messagesContainer>
      <ng-container *ngIf="!isLoadingMessages; else loadingMessages">
        <!-- Load More Button -->
        <div class="load-more-container" *ngIf="hasMoreMessages && messages.length > 0">
          <button
            class="load-more-btn"
            (click)="loadMoreMessages()"
            [disabled]="isLoadingMore"
          >
            <span *ngIf="!isLoadingMore">Load More</span>
            <span *ngIf="isLoadingMore">Loading...</span>
          </button>
        </div>

        <div
          class="message"
          *ngFor="let message of messages"
          [class.from-voter]="message.sender === 'voter'"
          [class.from-staff]="message.sender === 'staff'"
        >
          <div class="meta">
            <span>{{ message.sender === 'staff' ? 'You' : 'Voter' }}</span>
            <span>{{ message.timestamp?.toDate?.() ? (message.timestamp.toDate() | date:'short') : '' }}</span>
          </div>
          <p>{{ message.message }}</p>
        </div>

        <div class="end-of-chat" *ngIf="isChatEnded()">
          <div class="end-content">
            <div class="end-icon">✓</div>
            <h3>End of Chat</h3>
            <p>This chat has been completed. You can no longer send messages.</p>
          </div>
        </div>

        <p class="empty" *ngIf="messages.length === 0 && !isChatEnded()">No messages yet.</p>
      </ng-container>
    </div>

    <!-- Jump to Latest Button - At Bottom -->
    <div class="jump-to-latest-container" *ngIf="isViewingOlderMessages">
      <button
        class="jump-to-latest-btn"
        (click)="jumpToLatest()"
      >
        <span class="material-icons">arrow_downward</span>
        Jump to Latest
      </button>
    </div>

    <form class="composer" (ngSubmit)="sendMessage()" *ngIf="!isChatEnded()">
      <textarea
        [(ngModel)]="messageText"
        name="message"
        rows="2"
        placeholder="Type your response..."
        (keydown.enter)="handleEnterKey($event)"
        required
      ></textarea>
      <button type="submit" [disabled]="isSending || !messageText.trim()">Send</button>
    </form>

    <div class="composer-disabled" *ngIf="isChatEnded()">
      <p>Chat is closed. No more messages can be sent.</p>
    </div>
  </section>

  <ng-template #noSelection>
    <section class="chat-panel placeholder">
      <p>Select a request to open the chat room.</p>
    </section>
  </ng-template>

  <ng-template #loadingRequests>
    <div class="loading">Loading requests…</div>
  </ng-template>

  <ng-template #loadingMessages>
    <div class="loading">Loading chat…</div>
  </ng-template>
</div>

