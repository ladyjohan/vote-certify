rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {
    // Helper lookups so we don't repeat Firestore reads
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userRole() {
      return userDoc().data.role;
    }

    function requestDoc(requestId) {
      return get(/databases/$(database)/documents/requests/$(requestId));
    }

    function isRequestVoter(requestId) {
      return requestDoc(requestId).data.email == request.auth.token.email;
    }

    function isStaffLike() {
      return userRole() in ['admin', 'staff'];
    }

    // Allow chat access only to the voter tied to the request or staff/admin
    match /chats/{requestId}/messages/{messageId} {
      allow read, write: if request.auth != null &&
        (isRequestVoter(requestId) || isStaffLike());
    }

    // =========================
    // ANALYTICS COLLECTION
    // =========================
    // Lightweight visitor tracking - unauthenticated access allowed
    // Only tracks aggregated daily data to minimize quota usage
    match /analytics/{date} {
      // READ: Only admin/staff can read analytics
      allow read: if request.auth != null && isStaffLike();

      // CREATE/UPDATE: Unauthenticated visitors can track visits
      // Limited to small data writes: totalVisits, uniqueUsers counts only
      allow create, update: if 
        request.resource.data.keys().hasOnly(['date', 'totalVisits', 'uniqueUsers', 'uniqueUserIds']) &&
        request.resource.data.totalVisits is int &&
        request.resource.data.uniqueUsers is int &&
        request.resource.data.uniqueUserIds is list &&
        request.resource.data.uniqueUserIds.size() <= 1000;
      
      // DELETE: Only admin can delete analytics
      allow delete: if request.auth != null && isStaffLike();
    }

    // =========================
    // LOGIN HISTORY COLLECTION
    // =========================
    match /login_history/{document=**} {
      // READ: Only authenticated admin and staff can read login history
      allow read: if request.auth != null && isStaffLike();

      // WRITE: Any authenticated user can write their own login/logout records
      allow write: if request.auth != null;
    }

    // =========================
    // USERS COLLECTION
    // =========================
    match /users/{userId} {
      
      // READ: Any authenticated user
      allow read: if request.auth != null;

      // CREATE:
      // - Voter can create their own account
      // - Admin can create staff accounts
      allow create: if
        (request.auth != null && request.auth.uid == userId) ||
        (request.auth != null &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');

      // UPDATE:
      // - User can update their own data
      // - Admin/Staff can update any user
      // - Unauthenticated update allowed for email verification (status â†’ verified)
      allow update: if
        // Authenticated user updating their own profile
        (request.auth != null && request.auth.uid == userId) ||

        // Admin or staff updating any user
        (request.auth != null &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'staff']) ||

        // Unauthenticated email verification update
        (request.auth == null &&
         request.resource.data.keys().hasOnly(['status']) &&
         request.resource.data.status == 'verified');

      // DELETE: Only admin can delete users
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // =========================
    // REQUESTS COLLECTION
    // =========================
    match /requests/{requestId} {
      
      // READ: Any authenticated user
      allow read: if request.auth != null;

      // CREATE: Authenticated user can create a request
      // if their email matches the one in the request
      allow create: if request.auth != null &&
        request.resource.data.email == request.auth.token.email;

      // UPDATE: Staff/Admin can update request status
      allow update: if request.auth != null &&
        isStaffLike();

      // UPDATE: Voters can update their own pending requests
      allow update: if request.auth != null &&
        isRequestVoter(requestId) &&
        resource.data.status == 'Pending';

      // DELETE: Staff/Admin can delete only if status is "Pending"
      allow delete: if request.auth != null &&
        isStaffLike() &&
        resource.data.status == 'Pending';
    }
  }
}

